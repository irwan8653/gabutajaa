<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi Aplikasi Irwan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #111827;
        color: #e5e7eb;
      }
      .app-container {
        background-color: #1f2937;
        border-radius: 1.5rem;
        box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.2);
      }
      .tab-btn {
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
      }
      .tab-btn.active {
        border-bottom-color: #4f46e5;
        color: white;
      }
      .app-content {
        display: none;
      }
      .app-content.active {
        display: block;
        animation: fadeIn 0.5s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .translate-panel textarea {
        background-color: #374151;
        border: 2px solid #4b5563;
        color: white;
        transition: all 0.3s ease-in-out;
      }
      .translate-panel textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
      }
      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        color: #9ca3af;
      }
      .panel-actions button {
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 50%;
      }
      .panel-actions button:hover {
        background-color: #4b5563;
        color: white;
      }
      .btn {
        transition: all 0.2s ease-in-out;
      }
      .btn:hover:not(:disabled) {
        transform: translateY(-2px);
      }
      .btn:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }
      .btn-primary {
        background-color: #4f46e5;
      }
      .btn-primary:hover:not(:disabled) {
        background-color: #4338ca;
      }
      .btn-secondary {
        background-color: #374151;
      }
      .btn-secondary:hover:not(:disabled) {
        background-color: #4b5563;
      }
      /* Class baru untuk tombol hijau */
      .btn-success {
        background-color: #16a34a;
        color: white;
      }
      .btn-success:hover:not(:disabled) {
        background-color: #15803d;
      }
      .hidden-view {
        display: none;
      }
      #toast-notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        border-radius: 8px;
        color: white;
        z-index: 100;
        transition: opacity 0.5s, top 0.5s;
        opacity: 0;
        pointer-events: none;
      }
      #toast-notification.show {
        top: 40px;
        opacity: 1;
      }
      .toast-success {
        background-color: #16a34a;
      }
      .toast-error {
        background-color: #dc2626;
      }
      .toast-info {
        background-color: #2563eb;
      }
      #chat-messages {
        scroll-behavior: smooth;
      }
      #chat-messages p {
        max-width: 85%;
      }
      .chat-bubble {
        position: absolute;
        background-color: #4f46e5;
        color: white;
        padding: 10px 18px;
        border-radius: 18px;
        font-size: 1rem;
        font-weight: 500;
        white-space: nowrap;
        max-width: 85%;
        overflow: hidden;
        text-overflow: ellipsis;
        top: 4.5rem;
        right: 1rem;
        opacity: 0;
        transform: scale(0.9) translateY(10px);
        transition: all 0.3s ease-out;
        pointer-events: none;
        z-index: 20;
      }
      .chat-bubble.show {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
      .chat-bubble::after {
        content: "";
        position: absolute;
        bottom: 100%;
        right: 1.5rem;
        border-width: 8px;
        border-style: solid;
        border-color: transparent transparent #4f46e5 transparent;
      }
      .custom-select-container {
        position: relative;
        width: 100%;
        margin-bottom: 1rem;
      }
      .custom-select-trigger {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background-color: #374151;
        border: 2px solid #4b5563;
        border-radius: 0.5rem;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
      }
      .custom-select-trigger:hover {
        border-color: #6366f1;
      }
      .custom-select-trigger .selected-option {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .custom-select-trigger .arrow {
        transition: transform 0.3s ease;
      }
      .custom-select-container.open .arrow {
        transform: rotate(180deg);
      }
      .custom-options {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        right: 0;
        background-color: #374151;
        border: 1px solid #4b5563;
        border-radius: 0.5rem;
        z-index: 50;
        overflow: hidden;
        opacity: 0;
        transform: translateY(-10px);
        pointer-events: none;
        transition: all 0.3s ease-out;
      }
      .custom-select-container.open .custom-options {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }
      .custom-option {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      .custom-option:hover,
      .custom-option.selected {
        background-color: #4f46e5;
      }
      .custom-option:not(:last-child) {
        border-bottom: 1px solid #4b5563;
      }
    </style>
  </head>
  <body class="min-h-screen p-4 flex flex-col items-center">
    <h1
      class="text-3xl sm:text-4xl font-extrabold text-center text-white mb-8 font-poppins"
    >
      Game Gabut
    </h1>

    <div class="app-container w-full max-w-4xl p-6">
      <div class="flex justify-center border-b border-gray-700 mb-6">
        <button
          id="mainTabGenerator"
          class="tab-btn py-3 px-4 sm:px-6 text-base sm:text-lg font-semibold"
        >
          Generator
        </button>
        <button
          id="mainTabBKG"
          class="tab-btn py-3 px-4 sm:px-6 text-base sm:text-lg font-semibold"
        >
          Batu Gunting Kertas
        </button>
      </div>

      <div id="generatorApp" class="app-content">
        <div id="custom-select" class="custom-select-container">
          <div class="custom-select-trigger">
            <div class="selected-option"></div>
            <div class="arrow">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="m6 9 6 6 6-6" />
              </svg>
            </div>
          </div>
          <div class="custom-options">
            <div class="custom-option" data-value="text-to-garbled">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="m21 15-4-4-4 4" />
                <path
                  d="M17 11v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3"
                />
                <path d="m3 12 4 4 4-4" />
                <path d="M7 12V3" />
              </svg>
              <span>Teks Asli ‚Üí Teks Aneh</span>
            </div>
            <div class="custom-option" data-value="garbled-to-text">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="m21 15-4-4-4 4" />
                <path
                  d="M17 11v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3"
                />
                <path d="m3 12 4 4 4-4" />
                <path d="M7 12V3" />
              </svg>
              <span>Teks Aneh ‚Üí Teks Asli</span>
            </div>
            <div class="custom-option" data-value="text-to-morse">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10" />
                <path d="M12 8v4" />
                <path d="M12 16h.01" />
              </svg>
              <span>Teks ‚Üí Kode Morse</span>
            </div>
            <div class="custom-option" data-value="morse-to-text">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10" />
                <path d="M12 8v4" />
                <path d="M12 16h.01" />
              </svg>
              <span>Kode Morse ‚Üí Teks</span>
            </div>
          </div>
        </div>
        <div
          class="translate-container grid grid-cols-1 md:grid-cols-[1fr_auto_1fr] gap-4 items-start"
        >
          <div class="translate-panel flex flex-col">
            <div class="panel-header">
              <span id="input-lang-label">Teks Asli</span>
              <div class="panel-actions">
                <button id="input-copy-btn" title="Salin">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                    />
                  </svg>
                </button>
                <button id="input-clear-btn" title="Bersihkan">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </button>
              </div>
            </div>
            <textarea
              id="inputText"
              class="w-full p-4 rounded-lg resize-y flex-grow min-h-[150px] md:min-h-[200px]"
              placeholder="Masukkan teks..."
            ></textarea>
          </div>
          <div class="flex items-center justify-center">
            <button
              id="swap-btn"
              class="p-3 rounded-full hover:bg-gray-600 transition-all transform md:rotate-0 rotate-90"
              title="Tukar Bahasa"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"
                />
              </svg>
            </button>
          </div>
          <div class="translate-panel flex flex-col">
            <div class="panel-header">
              <span id="output-lang-label">Teks Aneh</span>
              <div class="panel-actions">
                <button id="output-copy-btn" title="Salin Hasil">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                    />
                  </svg>
                </button>
              </div>
            </div>
            <textarea
              id="outputText"
              readonly
              class="w-full p-4 rounded-lg resize-y flex-grow bg-gray-800 min-h-[150px] md:min-h-[200px]"
              placeholder="Hasil..."
            ></textarea>
          </div>
        </div>
      </div>

      <div id="bkgApp" class="app-content">
        <div id="toast-notification"></div>
        <div id="lobby-view" class="w-full max-w-md text-center mx-auto">
          <h2 class="font-title text-3xl font-bold mb-4">Game Lobi</h2>
          <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8 text-left">
            <h3 class="font-bold text-lg mb-2 text-center">Cara Bermain</h3>
            <ol class="list-decimal list-inside text-gray-300 space-y-1">
              <li>Masukkan nama Anda.</li>
              <li>
                <b>Buat Room:</b> Klik "Buat Room Baru" & bagikan kodenya.
              </li>
              <li>
                <b>Gabung Room:</b> Masukkan kode dari teman & klik "Gabung".
              </li>
            </ol>
          </div>
          <div class="bg-gray-800 p-8 rounded-xl shadow-2xl">
            <input
              id="player-name-input"
              type="text"
              placeholder="Masukkan Nama Anda"
              class="w-full bg-gray-700 text-white placeholder-gray-400 p-3 rounded-lg mb-4 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            />
            <button
              id="create-room-btn"
              class="btn btn-primary w-full py-3 rounded-lg font-semibold text-lg mb-4"
            >
              Buat Room Baru
            </button>
            <div class="flex items-center my-6">
              <hr class="w-full border-gray-600" />
              <span class="px-4 text-gray-400">ATAU</span>
              <hr class="w-full border-gray-600" />
            </div>
            <input
              id="room-code-input"
              type="text"
              placeholder="Masukkan Kode Room"
              class="w-full bg-gray-700 text-white placeholder-gray-400 p-3 rounded-lg mb-4 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            />
            <button
              id="join-room-btn"
              class="btn btn-secondary w-full py-3 rounded-lg font-semibold text-lg"
            >
              Gabung Room
            </button>
            <p id="lobby-error" class="text-red-400 mt-4 h-5"></p>
          </div>
        </div>
        <div
          id="game-view"
          class="w-full max-w-3xl text-center hidden-view mx-auto"
        >
          <div
            class="flex flex-col sm:flex-row sm:justify-between items-center mb-4 gap-3 sm:gap-0"
          >
            <button
              id="leave-room-btn"
              class="btn btn-secondary py-2 px-4 rounded-lg w-full sm:w-auto order-2 sm:order-1"
            >
              ‚Üê Keluar
            </button>
            <div class="text-center order-1 sm:order-2">
              <p class="text-sm text-gray-400">KODE ROOM</p>
              <div class="flex items-center justify-center gap-2">
                <strong
                  id="room-code-display"
                  class="text-2xl font-bold tracking-widest text-yellow-400"
                ></strong>
                <button id="copy-code-btn" title="Salin Kode">üìã</button>
              </div>
            </div>
            <button
              id="reset-score-btn"
              class="btn btn-secondary py-2 px-4 rounded-lg order-3 text-sm"
            >
              Reset Skor
            </button>
          </div>
          <p
            id="status-message"
            class="text-indigo-300 text-lg mb-4 mt-6 sm:mt-0"
          >
            Menginisialisasi permainan...
          </p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mb-6">
            <div
              id="p1-card"
              class="relative bg-gray-800 p-4 md:p-6 rounded-xl shadow-lg border-2 border-transparent"
            >
              <div id="p1-chat-bubble" class="chat-bubble"></div>
              <h2 id="player1-name" class="text-xl font-semibold mb-4 truncate">
                Pemain 1
              </h2>
              <div
                class="bg-gray-700 w-24 h-24 md:w-32 md:h-32 mx-auto rounded-lg flex items-center justify-center"
              >
                <span id="player1-choice-text" class="text-4xl md:text-5xl"
                  >?</span
                >
              </div>
            </div>
            <div
              id="p2-card"
              class="relative bg-gray-800 p-4 md:p-6 rounded-xl shadow-lg border-2 border-transparent"
            >
              <div id="p2-chat-bubble" class="chat-bubble"></div>
              <h2 id="player2-name" class="text-xl font-semibold mb-4 truncate">
                Pemain 2
              </h2>
              <div
                class="bg-gray-700 w-24 h-24 md:w-32 md:h-32 mx-auto rounded-lg flex items-center justify-center"
              >
                <span id="player2-choice-text" class="text-4xl md:text-5xl"
                  >?</span
                >
              </div>
            </div>
          </div>
          <div class="h-12 mb-4">
            <h2
              id="result-message"
              class="text-3xl font-bold text-yellow-400"
            ></h2>
          </div>
          <div
            id="choices"
            class="flex justify-center items-center gap-4 md:gap-6 mb-8"
          >
            <button
              id="rock"
              class="btn text-4xl p-4 bg-indigo-600 rounded-full shadow-lg"
            >
              ‚úä
            </button>
            <button
              id="paper"
              class="btn text-4xl p-4 bg-indigo-600 rounded-full shadow-lg"
            >
              ‚úã
            </button>
            <button
              id="scissors"
              class="btn text-4xl p-4 bg-indigo-600 rounded-full shadow-lg"
            >
              ‚úå
            </button>
          </div>
          <div
            id="play-again-container"
            class="flex justify-center hidden-view"
          >
            <button
              id="play-again-btn"
              class="btn btn-primary font-bold py-3 px-8 rounded-lg text-xl"
            ></button>
          </div>
          <div id="chat-container" class="mt-8 border-t-2 border-gray-700 pt-4">
            <h3 class="text-lg font-semibold mb-2 text-center">Chat Room</h3>
            <div
              id="chat-messages"
              class="h-40 bg-gray-900 rounded-lg p-3 overflow-y-auto flex flex-col gap-2"
            ></div>
            <div class="mt-3 flex gap-2">
              <input
                type="text"
                id="chat-input"
                class="flex-1 min-w-0 bg-gray-700 text-white p-2 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="Ketik pesan..."
              />
              <button
                id="chat-send-btn"
                class="btn btn-primary px-4 py-2 rounded-lg"
              >
                Kirim
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        onSnapshot,
        setDoc,
        updateDoc,
        getDoc,
        collection,
        deleteDoc,
        addDoc,
        serverTimestamp,
        query,
        orderBy,
        increment,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import {
        getDatabase,
        ref,
        onValue,
        set,
        onDisconnect,
        remove,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

      document.addEventListener("DOMContentLoaded", () => {
        // --- GLOBAL APP LOGIC ---
        const mainTabGenerator = document.getElementById("mainTabGenerator");
        const mainTabBKG = document.getElementById("mainTabBKG");
        const generatorApp = document.getElementById("generatorApp");
        const bkgApp = document.getElementById("bkgApp");

        function switchMainApp(app) {
          generatorApp.classList.toggle("active", app === "generator");
          bkgApp.classList.toggle("active", app === "bkg");
          mainTabGenerator.classList.toggle("active", app === "generator");
          mainTabBKG.classList.toggle("active", app === "bkg");
        }
        mainTabGenerator.addEventListener("click", () =>
          switchMainApp("generator")
        );
        mainTabBKG.addEventListener("click", () => switchMainApp("bkg"));

        // --- GENERATOR APP LOGIC ---
        const inputText = document.getElementById("inputText");
        const outputText = document.getElementById("outputText");
        const swapBtn = document.getElementById("swap-btn");
        const inputLangLabel = document.getElementById("input-lang-label");
        const outputLangLabel = document.getElementById("output-lang-label");
        const inputCopyBtn = document.getElementById("input-copy-btn");
        const outputCopyBtn = document.getElementById("output-copy-btn");
        const inputClearBtn = document.getElementById("input-clear-btn");
        const ENCRYPTION_MAP = {},
          DECRYPTION_MAP = {};
        const alphabet = "abcdefghijklmnopqrstuvwxyz";
        for (let i = 0; i < alphabet.length; i++) {
          const char = alphabet[i];
          const reversedChar = alphabet[alphabet.length - 1 - i];
          ENCRYPTION_MAP[char] = reversedChar;
          DECRYPTION_MAP[reversedChar] = char;
        }
        const MORSE_CODE_MAP = {
          A: "‚Ä¢-",
          B: "-‚Ä¢‚Ä¢‚Ä¢",
          C: "-‚Ä¢-‚Ä¢",
          D: "-‚Ä¢‚Ä¢",
          E: "‚Ä¢",
          F: "‚Ä¢‚Ä¢-‚Ä¢",
          G: "--‚Ä¢",
          H: "‚Ä¢‚Ä¢‚Ä¢‚Ä¢",
          I: "‚Ä¢‚Ä¢",
          J: "‚Ä¢---",
          K: "-‚Ä¢-",
          L: "‚Ä¢-‚Ä¢‚Ä¢",
          M: "--",
          N: "-‚Ä¢",
          O: "---",
          P: "‚Ä¢--‚Ä¢",
          Q: "--‚Ä¢-",
          R: "‚Ä¢-‚Ä¢",
          S: "‚Ä¢‚Ä¢‚Ä¢",
          T: "-",
          U: "‚Ä¢‚Ä¢-",
          V: "‚Ä¢‚Ä¢‚Ä¢-",
          W: "‚Ä¢--",
          X: "-‚Ä¢‚Ä¢-",
          Y: "-‚Ä¢--",
          Z: "--‚Ä¢‚Ä¢",
          0: "-----",
          1: "‚Ä¢----",
          2: "‚Ä¢‚Ä¢---",
          3: "‚Ä¢‚Ä¢‚Ä¢--",
          4: "‚Ä¢‚Ä¢‚Ä¢‚Ä¢-",
          5: "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢",
          6: "-‚Ä¢‚Ä¢‚Ä¢‚Ä¢",
          7: "--‚Ä¢‚Ä¢‚Ä¢",
          8: "---‚Ä¢‚Ä¢",
          9: "----‚Ä¢",
        };
        const REVERSE_MORSE_MAP = Object.fromEntries(
          Object.entries(MORSE_CODE_MAP).map((a) => a.reverse())
        );
        const translationFunctions = {
          "text-to-garbled": (text) =>
            text
              .split("")
              .map((char) =>
                char >= "a" && char <= "z"
                  ? ENCRYPTION_MAP[char]
                  : char >= "A" && char <= "Z"
                  ? ENCRYPTION_MAP[char.toLowerCase()].toUpperCase()
                  : char
              )
              .join(""),
          "garbled-to-text": (text) =>
            text
              .split("")
              .map((char) =>
                char >= "a" && char <= "z"
                  ? DECRYPTION_MAP[char]
                  : char >= "A" && char <= "Z"
                  ? DECRYPTION_MAP[char.toLowerCase()].toUpperCase()
                  : char
              )
              .join(""),
          "text-to-morse": (text) =>
            text
              .toUpperCase()
              .split("")
              .map((char) => MORSE_CODE_MAP[char] || (char === " " ? "/" : ""))
              .join("   "),
          "morse-to-text": (text) =>
            text
              .trim()
              .split(/[\s]{2,}/)
              .map(
                (code) => REVERSE_MORSE_MAP[code] || (code === "/" ? " " : "")
              )
              .join(""),
        };
        let generatorType = "text-to-garbled";

        function translate() {
          const text = inputText.value;
          const func = translationFunctions[generatorType];
          if (func) outputText.value = func(text);
        }
        function updateLabels() {
          const [from, to] = generatorType.split("-to-");
          inputLangLabel.textContent = from
            .replace(/-/g, " ")
            .replace(/\b\w/g, (c) => c.toUpperCase());
          outputLangLabel.textContent = to
            .replace(/-/g, " ")
            .replace(/\b\w/g, (c) => c.toUpperCase());
        }

        const customSelect = document.getElementById("custom-select");
        const customSelectTrigger = customSelect.querySelector(
          ".custom-select-trigger"
        );
        const selectedOptionEl = customSelect.querySelector(".selected-option");
        const options = customSelect.querySelectorAll(".custom-option");

        function updateSelectedOption(optionEl) {
          options.forEach((opt) => opt.classList.remove("selected"));
          optionEl.classList.add("selected");
          selectedOptionEl.innerHTML = optionEl.innerHTML;
          generatorType = optionEl.dataset.value;
          customSelect.classList.remove("open");
          updateLabels();
          translate();
        }

        customSelectTrigger.addEventListener("click", () =>
          customSelect.classList.toggle("open")
        );
        options.forEach((option) =>
          option.addEventListener("click", () => updateSelectedOption(option))
        );
        document.addEventListener("click", (e) => {
          if (!customSelect.contains(e.target))
            customSelect.classList.remove("open");
        });

        inputText.addEventListener("input", translate);
        swapBtn.addEventListener("click", () => {
          [inputText.value, outputText.value] = [
            outputText.value,
            inputText.value,
          ];
          const [from, to] = generatorType.split("-to-");
          const newType = `${to}-to-${from}`;
          const newOption = Array.from(options).find(
            (opt) => opt.dataset.value === newType
          );
          if (newOption) updateSelectedOption(newOption);
        });
        inputCopyBtn.addEventListener("click", () =>
          navigator.clipboard.writeText(inputText.value)
        );
        outputCopyBtn.addEventListener("click", () =>
          navigator.clipboard.writeText(outputText.value)
        );
        inputClearBtn.addEventListener("click", () => {
          inputText.value = "";
          outputText.value = "";
        });

        updateSelectedOption(options[0]);

        // --- BATU GUNTING KERTAS APP LOGIC ---
        const bkg_firebaseConfig = {
          apiKey: "AIzaSyCXU7oqo3m3ry7om9qQ5zfOGTu-mL_YOrc",
          authDomain: "realtime-database-99f23.firebaseapp.com",
          projectId: "realtime-database-99f23",
          storageBucket: "realtime-database-99f23.appspot.com",
          messagingSenderId: "642043922874",
          appId: "1:642043922874:web:6222047848a815392cf583",
          databaseURL:
            "https://realtime-database-99f23-default-rtdb.firebaseio.com/",
        };
        const bkg_app = initializeApp(bkg_firebaseConfig, "BKG_APP");
        const bkg_auth = getAuth(bkg_app);
        const bkg_db = getFirestore(bkg_app);
        const bkg_rtdb = getDatabase(bkg_app);
        const bkg_gamesCollection = collection(bkg_db, "rps-rooms");

        const bkg_player1Card = document.getElementById("p1-card");
        const bkg_player2Card = document.getElementById("p2-card");
        const bkg_lobbyView = document.getElementById("lobby-view");
        const bkg_gameView = document.getElementById("game-view");
        const bkg_playerNameInput =
          document.getElementById("player-name-input");
        const bkg_createRoomBtn = document.getElementById("create-room-btn");
        const bkg_roomCodeInput = document.getElementById("room-code-input");
        const bkg_joinRoomBtn = document.getElementById("join-room-btn");
        const bkg_lobbyError = document.getElementById("lobby-error");
        const bkg_roomCodeDisplay =
          document.getElementById("room-code-display");
        const bkg_copyCodeBtn = document.getElementById("copy-code-btn");
        const bkg_leaveRoomBtn = document.getElementById("leave-room-btn");
        const bkg_statusMessage = document.getElementById("status-message");
        const bkg_player1NameEl = document.getElementById("player1-name");
        const bkg_player2NameEl = document.getElementById("player2-name");
        const bkg_player1ChoiceText = document.getElementById(
          "player1-choice-text"
        );
        const bkg_player2ChoiceText = document.getElementById(
          "player2-choice-text"
        );
        const bkg_resultMessage = document.getElementById("result-message");
        const bkg_choices = document.getElementById("choices");
        const bkg_playAgainBtn = document.getElementById("play-again-btn");
        const bkg_toast = document.getElementById("toast-notification");
        const chatMessages = document.getElementById("chat-messages");
        const chatInput = document.getElementById("chat-input");
        const chatSendBtn = document.getElementById("chat-send-btn");
        const bkg_playAgainContainer = document.getElementById(
          "play-again-container"
        );
        const bkg_resetScoreBtn = document.getElementById("reset-score-btn");

        let bkg_currentUserId = null,
          bkg_currentPlayerName = "",
          bkg_currentRoomId = null,
          bkg_playerNumber = null,
          bkg_unsubscribeGame = null;
        let bkg_toastTimeout,
          afkTimeout = null,
          countdownInterval = null,
          rtdbListenerUnsubscribe = null,
          chatUnsubscribe = null;
        let chatBubbleTimeouts = {};
        let playersData = {};

        const bkg_showToast = (message, type = "info") => {
          clearTimeout(bkg_toastTimeout);
          bkg_toast.textContent = message;
          bkg_toast.className = `toast-${type}`;
          bkg_toast.classList.add("show");
          bkg_toastTimeout = setTimeout(
            () => bkg_toast.classList.remove("show"),
            4000
          );
        };
        const clearSession = () => {
          sessionStorage.removeItem("bkg_roomId");
          sessionStorage.removeItem("bkg_userId");
        };
        const bkg_switchView = (view) => {
          bkg_gameView.classList.toggle("hidden-view", view !== "game");
          bkg_lobbyView.classList.toggle("hidden-view", view === "game");
          if (view !== "game") {
            if (bkg_unsubscribeGame) bkg_unsubscribeGame();
            if (rtdbListenerUnsubscribe) rtdbListenerUnsubscribe();
            if (chatUnsubscribe) chatUnsubscribe();
            clearSession();
            bkg_resetGameState();
          }
        };
        const bkg_resetGameState = () => {
          bkg_currentRoomId = null;
          bkg_playerNumber = null;
          bkg_unsubscribeGame = null;
          rtdbListenerUnsubscribe = null;
          chatUnsubscribe = null;
          bkg_lobbyError.textContent = "";
          bkg_roomCodeInput.value = "";
          clearTimeout(afkTimeout);
          clearInterval(countdownInterval);
        };

        bkg_createRoomBtn.addEventListener("click", async () => {
          const name = bkg_playerNameInput.value.trim();
          if (!name) return bkg_showToast("Nama tidak boleh kosong.", "error");
          bkg_currentPlayerName = name;
          const roomId = Math.random()
            .toString(36)
            .substring(2, 7)
            .toUpperCase();
          const gameRef = doc(bkg_gamesCollection, roomId);
          await setDoc(gameRef, {
            players: {
              player1: {
                uid: bkg_currentUserId,
                name,
                choice: null,
                wantsToPlayAgain: false,
                status: "online",
                score: 0,
                wantsToReset: false,
              },
              player2: null,
            },
            createdAt: serverTimestamp(),
            choicesProcessed: false,
          });
          bkg_joinRoom(roomId);
        });

        bkg_joinRoomBtn.addEventListener("click", async () => {
          const name = bkg_playerNameInput.value.trim();
          if (!name) return bkg_showToast("Nama tidak boleh kosong.", "error");
          bkg_currentPlayerName = name;
          const roomId = bkg_roomCodeInput.value.trim().toUpperCase();
          if (!roomId)
            return bkg_showToast("Kode room tidak boleh kosong.", "error");
          const gameRef = doc(bkg_gamesCollection, roomId);
          const gameDoc = await getDoc(gameRef);
          if (gameDoc.exists()) {
            if (gameDoc.data().players.player2)
              bkg_showToast("Room ini sudah penuh.", "error");
            else {
              await updateDoc(gameRef, {
                "players.player2": {
                  uid: bkg_currentUserId,
                  name,
                  choice: null,
                  wantsToPlayAgain: false,
                  status: "online",
                  score: 0,
                  wantsToReset: false,
                },
              });
              bkg_joinRoom(roomId);
            }
          } else {
            bkg_showToast("Room tidak ditemukan.", "error");
          }
        });

        const bkg_joinRoom = (roomId) => {
          bkg_currentRoomId = roomId;
          bkg_switchView("game");
          bkg_roomCodeDisplay.textContent = roomId;
          const presenceRef = ref(
            bkg_rtdb,
            `/status/${roomId}/${bkg_currentUserId}`
          );
          onDisconnect(presenceRef).remove();
          set(presenceRef, true);
          sessionStorage.setItem("bkg_roomId", roomId);
          sessionStorage.setItem("bkg_userId", bkg_currentUserId);
          bkg_listenToGameUpdates(roomId);
        };

        bkg_leaveRoomBtn.addEventListener("click", async () => {
          if (!bkg_currentRoomId || !bkg_playerNumber) return;
          remove(
            ref(bkg_rtdb, `/status/${bkg_currentRoomId}/${bkg_currentUserId}`)
          );
          const gameRef = doc(bkg_gamesCollection, bkg_currentRoomId);
          if (bkg_playerNumber === "player1") await deleteDoc(gameRef);
          else await updateDoc(gameRef, { "players.player2": null });
          bkg_switchView("lobby");
        });

        bkg_copyCodeBtn.addEventListener("click", () =>
          navigator.clipboard
            .writeText(bkg_currentRoomId)
            .then(() => bkg_showToast("Kode room disalin!", "success"))
        );

        function bkg_listenToGameUpdates(roomId) {
          bkg_unsubscribeGame = onSnapshot(
            doc(bkg_gamesCollection, roomId),
            (doc) => {
              if (doc.exists()) bkg_updateUI(doc.data());
              else if (bkg_playerNumber === "player2") {
                bkg_showToast("Room ditutup oleh host.", "error");
                setTimeout(() => bkg_switchView("lobby"), 3000);
              }
            }
          );
          rtdbListenerUnsubscribe = onValue(
            ref(bkg_rtdb, `/status/${roomId}`),
            (snapshot) => {
              if (!bkg_currentRoomId) return;
              handleDisconnects(snapshot.val() || {});
            }
          );
          chatUnsubscribe = onSnapshot(
            query(
              collection(bkg_db, "rps-rooms", roomId, "messages"),
              orderBy("timestamp", "asc")
            ),
            (snapshot) => {
              updateChatBox(snapshot.docs);
              snapshot.docChanges().forEach((change) => {
                if (change.type === "added" && change.doc.data().timestamp)
                  showChatBubble(change.doc.data());
              });
            }
          );
        }
        function updateChatBox(docs) {
          chatMessages.innerHTML = "";
          docs.forEach((doc) => {
            const messageData = doc.data();
            const messageEl = document.createElement("p");
            const isMe = messageData.senderId === bkg_currentUserId;
            messageEl.innerHTML = `<span class="font-bold ${
              isMe ? "text-indigo-400" : "text-green-400"
            }">${messageData.senderName}:</span> ${messageData.text}`;
            messageEl.className = `w-full break-words p-2 rounded-lg ${
              isMe
                ? "bg-indigo-900/50 self-end text-right"
                : "bg-gray-700/50 self-start text-left"
            }`;
            chatMessages.appendChild(messageEl);
          });
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        function showChatBubble(messageData) {
          const p1_uid = playersData.player1?.uid;
          const p2_uid = playersData.player2?.uid;
          let bubbleId =
            messageData.senderId === p1_uid
              ? "p1-chat-bubble"
              : messageData.senderId === p2_uid
              ? "p2-chat-bubble"
              : null;
          if (!bubbleId) return;
          const bubbleEl = document.getElementById(bubbleId);
          if (!bubbleEl) return;
          if (chatBubbleTimeouts[bubbleId])
            clearTimeout(chatBubbleTimeouts[bubbleId]);
          bubbleEl.textContent = messageData.text;
          bubbleEl.classList.add("show");
          chatBubbleTimeouts[bubbleId] = setTimeout(
            () => bubbleEl.classList.remove("show"),
            4000
          );
        }
        const sendMessage = async () => {
          const text = chatInput.value.trim();
          if (text === "" || !bkg_currentRoomId) return;
          try {
            await addDoc(
              collection(bkg_db, "rps-rooms", bkg_currentRoomId, "messages"),
              {
                text,
                senderId: bkg_currentUserId,
                senderName: bkg_currentPlayerName,
                timestamp: serverTimestamp(),
              }
            );
            chatInput.value = "";
          } catch (error) {
            console.error("Gagal mengirim pesan:", error);
            bkg_showToast("Gagal mengirim pesan.", "error");
          }
        };
        chatSendBtn.addEventListener("click", sendMessage);
        chatInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") sendMessage();
        });
        async function handleDisconnects(onlineUsers) {
          if (!bkg_currentRoomId) return;
          const gameRef = doc(bkg_db, "rps-rooms", bkg_currentRoomId);
          const gameDoc = await getDoc(gameRef);
          if (!gameDoc.exists()) return;
          playersData = gameDoc.data().players;
          const { player1: p1, player2: p2 } = playersData;
          const updates = {};
          if (
            p1 &&
            p1.uid !== bkg_currentUserId &&
            !onlineUsers[p1.uid] &&
            p1.status === "online"
          )
            updates["players.player1.status"] = "offline";
          if (
            p2 &&
            p2.uid !== bkg_currentUserId &&
            !onlineUsers[p2.uid] &&
            p2.status === "online"
          )
            updates["players.player2.status"] = "offline";
          if (Object.keys(updates).length > 0)
            await updateDoc(gameRef, updates);
        }

        async function updateScoreAndState(winner) {
          if (!bkg_currentRoomId) return;
          const gameRef = doc(bkg_gamesCollection, bkg_currentRoomId);
          const updates = { choicesProcessed: true };
          if (winner !== "draw") {
            updates[`players.${winner}.score`] = increment(1);
          }
          await updateDoc(gameRef, updates);
        }

        function bkg_updateUI(gameState) {
          playersData = gameState.players;
          const { player1: p1, player2: p2 } = playersData;
          bkg_playerNumber =
            p1?.uid === bkg_currentUserId
              ? "player1"
              : p2?.uid === bkg_currentUserId
              ? "player2"
              : null;
          if (!bkg_playerNumber || !playersData[bkg_playerNumber]) return;

          bkg_player1Card.classList.toggle(
            "border-indigo-500",
            bkg_playerNumber === "player1"
          );
          bkg_player2Card.classList.toggle(
            "border-indigo-500",
            bkg_playerNumber === "player2"
          );
          bkg_player1NameEl.innerHTML = `${
            p1?.name || "Pemain 1"
          } <span class="text-yellow-400">(${p1?.score || 0})</span>`;
          bkg_player2NameEl.innerHTML = `${
            p2?.name || "Menunggu..."
          } <span class="text-yellow-400">(${p2?.score || 0})</span>`;

          const opponent =
            playersData[bkg_playerNumber === "player1" ? "player2" : "player1"];
          if (opponent && opponent.status === "offline") {
            bkg_statusMessage.textContent =
              "Lawan telah keluar dari permainan.";
            bkg_choices.classList.add("hidden");
            bkg_playAgainContainer.classList.add("hidden-view");
            bkg_resultMessage.textContent = "";
            clearTimeout(afkTimeout);
            clearInterval(countdownInterval);
            return;
          }

          const choiceMap = { rock: "‚úä", paper: "‚úã", scissors: "‚úå" };
          const displayChoice = (player, element, isOpponent) => {
            element.textContent = player?.choice
              ? !isOpponent || (p1?.choice && p2?.choice)
                ? choiceMap[player.choice]
                : "‚úÖ"
              : "?";
          };
          displayChoice(
            p1,
            bkg_player1ChoiceText,
            bkg_playerNumber !== "player1"
          );
          displayChoice(
            p2,
            bkg_player2ChoiceText,
            bkg_playerNumber !== "player2"
          );

          clearTimeout(afkTimeout);
          clearInterval(countdownInterval);

          if (p2) {
            if (p1.choice && p2.choice) {
              bkg_choices.classList.add("hidden");
              bkg_playAgainContainer.classList.remove("hidden-view");

              if (
                !gameState.choicesProcessed &&
                bkg_playerNumber === "player1"
              ) {
                const winner = determineWinner(p1.choice, p2.choice);
                updateScoreAndState(winner);
              }
              const winner = determineWinner(p1.choice, p2.choice);
              bkg_resultMessage.textContent =
                winner === "draw"
                  ? "Hasilnya Seri!"
                  : winner === bkg_playerNumber
                  ? "Kamu Menang! üéâ"
                  : "Kamu Kalah! üòû";

              const me = playersData[bkg_playerNumber];
              bkg_playAgainBtn.disabled = me.wantsToPlayAgain;
              bkg_playAgainBtn.textContent = me.wantsToPlayAgain
                ? "Menunggu Lawan..."
                : "Main Lagi";
              bkg_statusMessage.textContent = me.wantsToPlayAgain
                ? "Menunggu persetujuan lawan..."
                : opponent?.wantsToPlayAgain
                ? "Lawan menantangmu! Klik 'Main Lagi'."
                : "Klik 'Main Lagi' untuk rematch!";

              const myOpponent =
                playersData[
                  bkg_playerNumber === "player1" ? "player2" : "player1"
                ];
              bkg_resetScoreBtn.classList.remove(
                "btn-secondary",
                "btn-success"
              );
              if (me.wantsToReset) {
                bkg_resetScoreBtn.textContent = "Menunggu...";
                bkg_resetScoreBtn.disabled = true;
                bkg_resetScoreBtn.classList.add("btn-secondary");
              } else if (myOpponent?.wantsToReset) {
                bkg_resetScoreBtn.textContent = "Setujui";
                bkg_resetScoreBtn.disabled = false;
                bkg_resetScoreBtn.classList.add("btn-success");
              } else {
                bkg_resetScoreBtn.textContent = "Reset Skor";
                bkg_resetScoreBtn.disabled = false;
                bkg_resetScoreBtn.classList.add("btn-secondary");
              }

              if (
                p1.wantsToReset &&
                p2.wantsToReset &&
                bkg_playerNumber === "player1"
              )
                resetScores();
              if (
                p1.wantsToPlayAgain &&
                p2.wantsToPlayAgain &&
                bkg_playerNumber === "player1"
              )
                resetForNewRound();
            } else {
              bkg_choices.classList.remove("hidden");
              bkg_playAgainContainer.classList.add("hidden-view");
              bkg_resultMessage.textContent = "";
              let time = 30;
              bkg_statusMessage.textContent = `Pilih jagoanmu! Waktu: ${time}s`;
              countdownInterval = setInterval(() => {
                time--;
                bkg_statusMessage.textContent = `Pilih jagoanmu! Waktu: ${time}s`;
                if (time <= 0) clearInterval(countdownInterval);
              }, 1000);
              afkTimeout = setTimeout(() => handleAfkTimeout(p1, p2), 30000);
            }
          } else {
            bkg_statusMessage.textContent =
              "Bagikan kode untuk mengundang temanmu!";
            bkg_choices.classList.add("hidden");
            bkg_playAgainContainer.classList.add("hidden-view");
            bkg_resultMessage.textContent = "";
          }
        }

        async function handleAfkTimeout(p1, p2) {
          const gameRef = doc(bkg_gamesCollection, bkg_currentRoomId),
            updates = {};
          let winnerMessage = "Waktu habis! ";
          if (!p1.choice && !p2.choice) {
            updates["players.player1.choice"] = "rock";
            updates["players.player2.choice"] = "rock";
            winnerMessage += "Tidak ada yang memilih, hasilnya Seri!";
          } else if (!p2.choice) {
            updates["players.player2.choice"] = "none";
            winnerMessage += `${p2.name} tidak memilih, ${p1.name} menang!`;
          } else if (!p1.choice) {
            updates["players.player1.choice"] = "none";
            winnerMessage += `${p1.name} tidak memilih, ${p2.name} menang!`;
          }
          bkg_showToast(winnerMessage, "info");
          await updateDoc(gameRef, updates);
        }

        const determineWinner = (c1, c2) =>
          c1 === "none"
            ? "player2"
            : c2 === "none"
            ? "player1"
            : c1 === c2
            ? "draw"
            : (c1 === "rock" && c2 === "scissors") ||
              (c1 === "paper" && c2 === "rock") ||
              (c1 === "scissors" && c2 === "paper")
            ? "player1"
            : "player2";

        ["rock", "paper", "scissors"].forEach((choice) =>
          document
            .getElementById(choice)
            .addEventListener("click", () => bkg_handlePlayerChoice(choice))
        );

        const bkg_handlePlayerChoice = async (choice) => {
          if (!bkg_playerNumber || !bkg_currentRoomId) return;
          await updateDoc(doc(bkg_gamesCollection, bkg_currentRoomId), {
            [`players.${bkg_playerNumber}.choice`]: choice,
          });
        };

        bkg_playAgainBtn.addEventListener("click", async () => {
          if (!bkg_playerNumber || !bkg_currentRoomId) return;
          await updateDoc(doc(bkg_gamesCollection, bkg_currentRoomId), {
            [`players.${bkg_playerNumber}.wantsToPlayAgain`]: true,
          });
        });

        bkg_resetScoreBtn.addEventListener("click", async () => {
          if (!bkg_playerNumber || !bkg_currentRoomId) return;
          await updateDoc(doc(bkg_gamesCollection, bkg_currentRoomId), {
            [`players.${bkg_playerNumber}.wantsToReset`]: true,
          });
        });

        async function resetScores() {
          if (!bkg_currentRoomId) return;
          await updateDoc(doc(bkg_gamesCollection, bkg_currentRoomId), {
            "players.player1.score": 0,
            "players.player2.score": 0,
            "players.player1.wantsToReset": false,
            "players.player2.wantsToReset": false,
          });
        }

        async function resetForNewRound() {
          if (!bkg_currentRoomId) return;
          await updateDoc(doc(bkg_gamesCollection, bkg_currentRoomId), {
            "players.player1.choice": null,
            "players.player2.choice": null,
            "players.player1.wantsToPlayAgain": false,
            "players.player2.wantsToPlayAgain": false,
            choicesProcessed: false,
          });
        }

        async function checkForSavedSession() {
          const roomId = sessionStorage.getItem("bkg_roomId");
          const userId = sessionStorage.getItem("bkg_userId");
          if (!roomId || !userId || userId !== bkg_currentUserId) return;
          const gameRef = doc(bkg_gamesCollection, roomId);
          const gameDoc = await getDoc(gameRef);
          if (gameDoc.exists()) {
            const players = gameDoc.data().players;
            const player =
              players.player1?.uid === userId
                ? players.player1
                : players.player2;
            if (player) {
              if (player.status === "offline")
                await updateDoc(gameRef, {
                  [`players.${
                    players.player1?.uid === userId ? "player1" : "player2"
                  }.status`]: "online",
                });
              bkg_currentPlayerName = player.name;
              bkg_joinRoom(roomId);
              bkg_showToast("Berhasil terhubung kembali ke room!", "success");
            }
          } else {
            clearSession();
          }
        }

        onAuthStateChanged(bkg_auth, (user) => {
          if (user) {
            bkg_currentUserId = user.uid;
            checkForSavedSession();
          }
        });
        signInAnonymously(bkg_auth).catch((err) =>
          console.error("BKG Auth Error:", err)
        );

        switchMainApp("bkg");
      });
    </script>
  </body>
</html>
