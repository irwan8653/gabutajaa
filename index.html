<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi Aplikasi Irwan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #111827;
        color: #e5e7eb;
      }
      .app-container {
        background-color: #1f2937;
        border-radius: 1.5rem;
        box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.2);
      }
      .tab-btn {
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
      }
      .tab-btn.active {
        border-bottom-color: #4f46e5;
        color: white;
      }
      .app-content {
        display: none;
      }
      .app-content.active {
        display: block;
        animation: fadeIn 0.5s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .translate-panel textarea {
        background-color: #374151;
        border: 2px solid #4b5563;
        color: white;
        transition: all 0.3s ease-in-out;
      }
      .translate-panel textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
      }
      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        color: #9ca3af;
      }
      .panel-actions button {
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 50%;
      }
      .panel-actions button:hover {
        background-color: #4b5563;
        color: white;
      }
      .btn {
        transition: all 0.2s ease-in-out;
      }
      .btn:hover:not(:disabled) {
        transform: translateY(-2px);
      }
      .btn:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }
      .btn-primary {
        background-color: #4f46e5;
      }
      .btn-primary:hover:not(:disabled) {
        background-color: #4338ca;
      }
      .btn-secondary {
        background-color: #374151;
      }
      .btn-secondary:hover:not(:disabled) {
        background-color: #4b5563;
      }
      .hidden-view {
        display: none;
      }
      #toast-notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        border-radius: 8px;
        color: white;
        z-index: 100;
        transition: opacity 0.5s, top 0.5s;
        opacity: 0;
        pointer-events: none;
      }
      #toast-notification.show {
        top: 40px;
        opacity: 1;
      }
      .toast-success {
        background-color: #16a34a;
      }
      .toast-error {
        background-color: #dc2626;
      }
      .toast-info {
        background-color: #2563eb;
      }
    </style>
  </head>
  <body class="min-h-screen p-4 flex flex-col items-center">
    <h1
      class="text-3xl sm:text-4xl font-extrabold text-center text-white mb-8 font-poppins"
    >
      Game Gabut
    </h1>

    <div class="app-container w-full max-w-4xl p-6">
      <div class="flex justify-center border-b border-gray-700 mb-6">
        <button
          id="mainTabGenerator"
          class="tab-btn py-3 px-4 sm:px-6 text-base sm:text-lg font-semibold"
        >
          Generator
        </button>
        <button
          id="mainTabBKG"
          class="tab-btn py-3 px-4 sm:px-6 text-base sm:text-lg font-semibold"
        >
          Batu Gunting Kertas
        </button>
      </div>

      <div id="generatorApp" class="app-content">
        <div class="mb-4">
          <label for="generatorType" class="sr-only"
            >Pilih Jenis Generator</label
          >
          <select
            id="generatorType"
            class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          >
            <option value="text-to-garbled">Teks Asli ‚Üí Teks Aneh</option>
            <option value="garbled-to-text">Teks Aneh ‚Üí Teks Asli</option>
            <option value="text-to-morse">Teks ‚Üí Kode Morse</option>
            <option value="morse-to-text">Kode Morse ‚Üí Teks</option>
          </select>
        </div>
        <div
          class="translate-container grid grid-cols-1 md:grid-cols-[1fr_auto_1fr] gap-4 items-start"
        >
          <div class="translate-panel flex flex-col">
            <div class="panel-header">
              <span id="input-lang-label">Teks Asli</span>
              <div class="panel-actions">
                <button id="input-copy-btn" title="Salin">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                    />
                  </svg>
                </button>
                <button id="input-clear-btn" title="Bersihkan">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </button>
              </div>
            </div>
            <textarea
              id="inputText"
              class="w-full p-4 rounded-lg resize-y flex-grow min-h-[150px] md:min-h-[200px]"
              placeholder="Masukkan teks..."
            ></textarea>
          </div>

          <div class="flex items-center justify-center">
            <button
              id="swap-btn"
              class="p-3 rounded-full hover:bg-gray-600 transition-all transform md:rotate-0 rotate-90"
              title="Tukar Bahasa"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"
                />
              </svg>
            </button>
          </div>

          <div class="translate-panel flex flex-col">
            <div class="panel-header">
              <span id="output-lang-label">Teks Aneh</span>
              <div class="panel-actions">
                <button id="output-copy-btn" title="Salin Hasil">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                    />
                  </svg>
                </button>
              </div>
            </div>
            <textarea
              id="outputText"
              readonly
              class="w-full p-4 rounded-lg resize-y flex-grow bg-gray-800 min-h-[150px] md:min-h-[200px]"
              placeholder="Hasil..."
            ></textarea>
          </div>
        </div>
      </div>

      <div id="bkgApp" class="app-content">
        <div id="toast-notification"></div>
        <div id="lobby-view" class="w-full max-w-md text-center mx-auto">
          <h2 class="font-title text-3xl font-bold mb-4">Game Lobi</h2>
          <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8 text-left">
            <h3 class="font-bold text-lg mb-2 text-center">Cara Bermain</h3>
            <ol class="list-decimal list-inside text-gray-300 space-y-1">
              <li>Masukkan nama Anda.</li>
              <li>
                <b>Buat Room:</b> Klik "Buat Room Baru" & bagikan kodenya.
              </li>
              <li>
                <b>Gabung Room:</b> Masukkan kode dari teman & klik "Gabung".
              </li>
            </ol>
          </div>
          <div class="bg-gray-800 p-8 rounded-xl shadow-2xl">
            <input
              id="player-name-input"
              type="text"
              placeholder="Masukkan Nama Anda"
              class="w-full bg-gray-700 text-white placeholder-gray-400 p-3 rounded-lg mb-4 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            /><button
              id="create-room-btn"
              class="btn btn-primary w-full py-3 rounded-lg font-semibold text-lg mb-4"
            >
              Buat Room Baru
            </button>
            <div class="flex items-center my-6">
              <hr class="w-full border-gray-600" />
              <span class="px-4 text-gray-400">ATAU</span>
              <hr class="w-full border-gray-600" />
            </div>
            <input
              id="room-code-input"
              type="text"
              placeholder="Masukkan Kode Room"
              class="w-full bg-gray-700 text-white placeholder-gray-400 p-3 rounded-lg mb-4 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            /><button
              id="join-room-btn"
              class="btn btn-secondary w-full py-3 rounded-lg font-semibold text-lg"
            >
              Gabung Room
            </button>
            <p id="lobby-error" class="text-red-400 mt-4 h-5"></p>
          </div>
        </div>
        <div
          id="game-view"
          class="w-full max-w-3xl text-center hidden-view mx-auto"
        >
          <div
            class="flex flex-col sm:flex-row sm:justify-between items-center mb-4 gap-3 sm:gap-0"
          >
            <button
              id="leave-room-btn"
              class="btn btn-secondary py-2 px-4 rounded-lg w-full sm:w-auto order-2 sm:order-1"
            >
              ‚Üê Keluar
            </button>
            <div class="text-center order-1 sm:order-2">
              <p class="text-sm text-gray-400">KODE ROOM</p>
              <div class="flex items-center justify-center gap-2">
                <strong
                  id="room-code-display"
                  class="text-2xl font-bold tracking-widest text-yellow-400"
                ></strong>
                <button id="copy-code-btn" title="Salin Kode">üìã</button>
              </div>
            </div>
            <div class="hidden sm:block order-3" style="width: 110px"></div>
          </div>

          <p
            id="status-message"
            class="text-indigo-300 text-lg mb-4 mt-6 sm:mt-0"
          >
            Menginisialisasi permainan...
          </p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mb-6">
            <div
              id="p1-card"
              class="bg-gray-800 p-4 md:p-6 rounded-xl shadow-lg border-2 border-transparent"
            >
              <h2 id="player1-name" class="text-xl font-semibold mb-4 truncate">
                Pemain 1
              </h2>
              <div
                class="bg-gray-700 w-24 h-24 md:w-32 md:h-32 mx-auto rounded-lg flex items-center justify-center"
              >
                <span id="player1-choice-text" class="text-4xl md:text-5xl"
                  >?</span
                >
              </div>
            </div>
            <div
              id="p2-card"
              class="bg-gray-800 p-4 md:p-6 rounded-xl shadow-lg border-2 border-transparent"
            >
              <h2 id="player2-name" class="text-xl font-semibold mb-4 truncate">
                Pemain 2
              </h2>
              <div
                class="bg-gray-700 w-24 h-24 md:w-32 md:h-32 mx-auto rounded-lg flex items-center justify-center"
              >
                <span id="player2-choice-text" class="text-4xl md:text-5xl"
                  >?</span
                >
              </div>
            </div>
          </div>
          <div class="h-12 mb-4">
            <h2
              id="result-message"
              class="text-3xl font-bold text-yellow-400"
            ></h2>
          </div>
          <div
            id="choices"
            class="flex justify-center items-center gap-4 md:gap-6 mb-8"
          >
            <button
              id="rock"
              class="btn text-4xl p-4 bg-indigo-600 rounded-full shadow-lg"
            >
              ‚úä
            </button>
            <button
              id="paper"
              class="btn text-4xl p-4 bg-indigo-600 rounded-full shadow-lg"
            >
              ‚úã
            </button>
            <button
              id="scissors"
              class="btn text-4xl p-4 bg-indigo-600 rounded-full shadow-lg"
            >
              ‚úå
            </button>
          </div>
          <button
            id="play-again-btn"
            class="hidden-view btn btn-primary font-bold py-3 px-8 rounded-lg text-xl"
          ></button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        onSnapshot,
        setDoc,
        updateDoc,
        getDoc,
        collection,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import {
        getDatabase,
        ref,
        onValue,
        set,
        onDisconnect,
        remove,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

      // --- GLOBAL APP SWITCHER LOGIC ---
      const mainTabGenerator = document.getElementById("mainTabGenerator"),
        mainTabBKG = document.getElementById("mainTabBKG"),
        generatorApp = document.getElementById("generatorApp"),
        bkgApp = document.getElementById("bkgApp");
      function switchMainApp(e) {
        generatorApp.classList.remove("active"),
          bkgApp.classList.remove("active"),
          mainTabGenerator.classList.remove("active"),
          mainTabBKG.classList.remove("active"),
          "generator" === e
            ? (generatorApp.classList.add("active"),
              mainTabGenerator.classList.add("active"))
            : "bkg" === e &&
              (bkgApp.classList.add("active"),
              mainTabBKG.classList.add("active"));
      }
      mainTabGenerator.addEventListener("click", () =>
        switchMainApp("generator")
      ),
        mainTabBKG.addEventListener("click", () => switchMainApp("bkg")),
        switchMainApp("bkg");

      // --- GENERATOR APP LOGIC ---
      const generatorType = document.getElementById("generatorType"),
        inputText = document.getElementById("inputText"),
        outputText = document.getElementById("outputText"),
        swapBtn = document.getElementById("swap-btn"),
        inputLangLabel = document.getElementById("input-lang-label"),
        outputLangLabel = document.getElementById("output-lang-label"),
        inputCopyBtn = document.getElementById("input-copy-btn"),
        outputCopyBtn = document.getElementById("output-copy-btn"),
        inputClearBtn = document.getElementById("input-clear-btn"),
        ENCRYPTION_MAP = {},
        DECRYPTION_MAP = {},
        alphabet = "abcdefghijklmnopqrstuvwxyz";
      for (let e = 0; e < alphabet.length; e++) {
        const t = alphabet[e],
          a = alphabet[alphabet.length - 1 - e];
        (ENCRYPTION_MAP[t] = a), (DECRYPTION_MAP[a] = t);
      }
      const MORSE_CODE_MAP = {
        A: "‚Ä¢-",
        B: "-‚Ä¢‚Ä¢‚Ä¢",
        C: "-‚Ä¢-‚Ä¢",
        D: "-‚Ä¢‚Ä¢",
        E: "‚Ä¢",
        F: "‚Ä¢‚Ä¢-‚Ä¢",
        G: "--‚Ä¢",
        H: "‚Ä¢‚Ä¢‚Ä¢‚Ä¢",
        I: "‚Ä¢‚Ä¢",
        J: "‚Ä¢---",
        K: "-‚Ä¢-",
        L: "‚Ä¢-‚Ä¢‚Ä¢",
        M: "--",
        N: "-‚Ä¢",
        O: "---",
        P: "‚Ä¢--‚Ä¢",
        Q: "--‚Ä¢-",
        R: "‚Ä¢-‚Ä¢",
        S: "‚Ä¢‚Ä¢‚Ä¢",
        T: "-",
        U: "‚Ä¢‚Ä¢-",
        V: "‚Ä¢‚Ä¢‚Ä¢-",
        W: "‚Ä¢--",
        X: "-‚Ä¢‚Ä¢-",
        Y: "-‚Ä¢--",
        Z: "--‚Ä¢‚Ä¢",
        0: "-----",
        1: "‚Ä¢----",
        2: "‚Ä¢‚Ä¢---",
        3: "‚Ä¢‚Ä¢‚Ä¢--",
        4: "‚Ä¢‚Ä¢‚Ä¢‚Ä¢-",
        5: "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢",
        6: "-‚Ä¢‚Ä¢‚Ä¢‚Ä¢",
        7: "--‚Ä¢‚Ä¢‚Ä¢",
        8: "---‚Ä¢‚Ä¢",
        9: "----‚Ä¢",
      };
      const REVERSE_MORSE_MAP = Object.fromEntries(
          Object.entries(MORSE_CODE_MAP).map((e) => e.reverse())
        ),
        garbledFn = (e) =>
          e
            .split("")
            .map((e) =>
              e >= "a" && e <= "z"
                ? ENCRYPTION_MAP[e]
                : e >= "A" && e <= "Z"
                ? ENCRYPTION_MAP[e.toLowerCase()].toUpperCase()
                : e
            )
            .join(""),
        ungarbledFn = (e) =>
          e
            .split("")
            .map((e) =>
              e >= "a" && e <= "z"
                ? DECRYPTION_MAP[e]
                : e >= "A" && e <= "Z"
                ? DECRYPTION_MAP[e.toLowerCase()].toUpperCase()
                : e
            )
            .join("");
      const textToMorseFn = (e) =>
          e
            .toUpperCase()
            .split("")
            .map((e) => MORSE_CODE_MAP[e] || (" " === e ? "/" : ""))
            .join("   "),
        morseToTextFn = (e) =>
          e
            .trim()
            .split(/[\s]{2,}/)
            .map((e) => REVERSE_MORSE_MAP[e] || ("/" === e ? " " : ""))
            .join("");
      function translate() {
        const e = generatorType.value,
          t = inputText.value,
          a = translationFunctions[e];
        a && (outputText.value = a(t));
      }
      function updateLabels() {
        const [e, t] = generatorType.value.split("-to-");
        (inputLangLabel.textContent = e
          .replace(/-/g, " ")
          .replace(/\b\w/g, (e) => e.toUpperCase())),
          (outputLangLabel.textContent = t
            .replace(/-/g, " ")
            .replace(/\b\w/g, (e) => e.toUpperCase()));
      }
      const translationFunctions = {
        "text-to-garbled": garbledFn,
        "garbled-to-text": ungarbledFn,
        "text-to-morse": textToMorseFn,
        "morse-to-text": morseToTextFn,
      };
      inputText.addEventListener("input", translate),
        generatorType.addEventListener("change", () => {
          updateLabels(), translate();
        }),
        swapBtn.addEventListener("click", () => {
          [inputText.value, outputText.value] = [
            outputText.value,
            inputText.value,
          ];
          const [e, t] = generatorType.value.split("-to-"),
            a = `${t}-to-${e}`;
          Array.from(generatorType.options).some((e) => e.value === a) &&
            (generatorType.value = a),
            updateLabels(),
            translate();
        }),
        inputCopyBtn.addEventListener("click", () =>
          navigator.clipboard.writeText(inputText.value)
        ),
        outputCopyBtn.addEventListener("click", () =>
          navigator.clipboard.writeText(outputText.value)
        ),
        inputClearBtn.addEventListener("click", () => {
          (inputText.value = ""), (outputText.value = "");
        }),
        updateLabels();

      // --- BATU GUNTING KERTAS APP LOGIC ---
      const bkg_firebaseConfig = {
        apiKey: "AIzaSyCXU7oqo3m3ry7om9qQ5zfOGTu-mL_YOrc",
        authDomain: "realtime-database-99f23.firebaseapp.com",
        projectId: "realtime-database-99f23",
        storageBucket: "realtime-database-99f23.appspot.com",
        messagingSenderId: "642043922874",
        appId: "1:642043922874:web:6222047848a815392cf583",
        databaseURL:
          "https://realtime-database-99f23-default-rtdb.firebaseio.com/",
      };

      const bkg_app = initializeApp(bkg_firebaseConfig, "BKG_APP");
      const bkg_auth = getAuth(bkg_app);
      const bkg_db = getFirestore(bkg_app);
      const bkg_rtdb = getDatabase(bkg_app);
      const bkg_gamesCollection = collection(bkg_db, "rps-rooms");

      const bkg_lobbyView = document.getElementById("lobby-view"),
        bkg_gameView = document.getElementById("game-view"),
        bkg_playerNameInput = document.getElementById("player-name-input"),
        bkg_createRoomBtn = document.getElementById("create-room-btn"),
        bkg_roomCodeInput = document.getElementById("room-code-input"),
        bkg_joinRoomBtn = document.getElementById("join-room-btn"),
        bkg_lobbyError = document.getElementById("lobby-error"),
        bkg_roomCodeDisplay = document.getElementById("room-code-display"),
        bkg_copyCodeBtn = document.getElementById("copy-code-btn"),
        bkg_leaveRoomBtn = document.getElementById("leave-room-btn"),
        bkg_statusMessage = document.getElementById("status-message"),
        bkg_player1NameEl = document.getElementById("player1-name"),
        bkg_player2NameEl = document.getElementById("player2-name"),
        bkg_player1ChoiceText = document.getElementById("player1-choice-text"),
        bkg_player2ChoiceText = document.getElementById("player2-choice-text"),
        bkg_resultMessage = document.getElementById("result-message"),
        bkg_choices = document.getElementById("choices"),
        bkg_playAgainBtn = document.getElementById("play-again-btn"),
        bkg_toast = document.getElementById("toast-notification");

      let bkg_currentUserId = null,
        bkg_currentPlayerName = "",
        bkg_currentRoomId = null,
        bkg_playerNumber = null,
        bkg_unsubscribeGame = null;
      let bkg_toastTimeout,
        afkTimeout = null,
        countdownInterval = null,
        rtdbListenerUnsubscribe = null;

      const bkg_showToast = (message, type = "info") => {
        clearTimeout(bkg_toastTimeout),
          (bkg_toast.textContent = message),
          (bkg_toast.className = `toast-${type}`),
          bkg_toast.classList.add("show"),
          (bkg_toastTimeout = setTimeout(() => {
            bkg_toast.classList.remove("show");
          }, 4e3));
      };

      // PERUBAHAN: Fungsi clear session
      const clearSession = () => {
        sessionStorage.removeItem("bkg_roomId");
        sessionStorage.removeItem("bkg_userId");
      };

      const bkg_switchView = (view) => {
        if (view === "game") {
          bkg_lobbyView.classList.add("hidden-view"),
            bkg_gameView.classList.remove("hidden-view");
        } else {
          bkg_gameView.classList.add("hidden-view"),
            bkg_lobbyView.classList.remove("hidden-view"),
            bkg_unsubscribeGame && bkg_unsubscribeGame(),
            rtdbListenerUnsubscribe && rtdbListenerUnsubscribe(),
            clearSession(),
            bkg_resetGameState();
        }
      };
      const bkg_resetGameState = () => {
        (bkg_currentRoomId = null),
          (bkg_playerNumber = null),
          (bkg_unsubscribeGame = null),
          (rtdbListenerUnsubscribe = null),
          (bkg_lobbyError.textContent = ""),
          (bkg_roomCodeInput.value = ""),
          clearTimeout(afkTimeout),
          clearInterval(countdownInterval);
      };

      bkg_createRoomBtn.addEventListener("click", async () => {
        const name = bkg_playerNameInput.value.trim();
        if (!name)
          return (
            (bkg_lobbyError.textContent = "Nama tidak boleh kosong."), void 0
          );
        bkg_currentPlayerName = name;
        const roomId = Math.random().toString(36).substring(2, 7).toUpperCase();
        const gameRef = doc(bkg_gamesCollection, roomId);
        await setDoc(gameRef, {
          players: {
            player1: {
              uid: bkg_currentUserId,
              name: bkg_currentPlayerName,
              choice: null,
              wantsToPlayAgain: !1,
              status: "online",
            },
            player2: null,
          },
          createdAt: new Date(),
        }),
          bkg_joinRoom(roomId);
      });
      bkg_joinRoomBtn.addEventListener("click", async () => {
        const name = bkg_playerNameInput.value.trim();
        if (!name)
          return (
            (bkg_lobbyError.textContent = "Nama tidak boleh kosong."), void 0
          );
        bkg_currentPlayerName = name;
        const roomId = bkg_roomCodeInput.value.trim().toUpperCase();
        if (!roomId)
          return (
            (bkg_lobbyError.textContent = "Kode room tidak boleh kosong."),
            void 0
          );
        const gameRef = doc(bkg_gamesCollection, roomId),
          docSnap = await getDoc(gameRef);
        docSnap.exists()
          ? docSnap.data().players.player2
            ? (bkg_lobbyError.textContent = "Room ini sudah penuh.")
            : (await updateDoc(gameRef, {
                "players.player2": {
                  uid: bkg_currentUserId,
                  name: bkg_currentPlayerName,
                  choice: null,
                  wantsToPlayAgain: !1,
                  status: "online",
                },
              }),
              bkg_joinRoom(roomId))
          : (bkg_lobbyError.textContent = "Room tidak ditemukan.");
      });

      const bkg_joinRoom = (roomId) => {
        bkg_currentRoomId = roomId;
        bkg_switchView("game");
        bkg_roomCodeDisplay.textContent = roomId;

        const userStatusRef = ref(
          bkg_rtdb,
          `/status/${roomId}/${bkg_currentUserId}`
        );
        onDisconnect(userStatusRef).remove();
        set(userStatusRef, true);

        // PERUBAHAN: Simpan sesi ke sessionStorage
        sessionStorage.setItem("bkg_roomId", roomId);
        sessionStorage.setItem("bkg_userId", bkg_currentUserId);

        bkg_listenToGameUpdates(roomId);
      };

      bkg_leaveRoomBtn.addEventListener("click", async () => {
        if (!bkg_currentRoomId || !bkg_playerNumber) return;
        const userStatusRef = ref(
          bkg_rtdb,
          `/status/${bkg_currentRoomId}/${bkg_currentUserId}`
        );
        remove(userStatusRef);

        const gameRef = doc(bkg_gamesCollection, bkg_currentRoomId);
        if (bkg_playerNumber === "player1") {
          await deleteDoc(gameRef);
        } else {
          await updateDoc(gameRef, { "players.player2": null });
        }

        bkg_switchView("lobby"); // switchView akan membersihkan session
      });

      bkg_copyCodeBtn.addEventListener("click", () => {
        navigator.clipboard
          .writeText(bkg_currentRoomId)
          .then(() => bkg_showToast("Kode room disalin!", "success"));
      });

      function bkg_listenToGameUpdates(roomId) {
        const gameRef = doc(bkg_gamesCollection, roomId);
        bkg_unsubscribeGame = onSnapshot(gameRef, (docSnap) => {
          if (!docSnap.exists()) {
            if ("player2" === bkg_playerNumber) {
              bkg_showToast("Room ditutup oleh host.", "error");
              setTimeout(() => bkg_switchView("lobby"), 3e3);
            }
            return;
          }
          const gameState = docSnap.data();
          bkg_updateUI(gameState);
        });

        const roomStatusRef = ref(bkg_rtdb, `/status/${roomId}`);
        rtdbListenerUnsubscribe = onValue(roomStatusRef, (statusSnap) => {
          const onlineUsers = statusSnap.val() || {};
          handleDisconnects(onlineUsers);
        });
      }

      async function handleDisconnects(onlineUsers) {
        const gameRef = doc(bkg_db, "rps-rooms", bkg_currentRoomId);
        const gameSnap = await getDoc(gameRef);
        if (!gameSnap.exists()) return;

        const { players } = gameSnap.data();
        const p1 = players.player1;
        const p2 = players.player2;

        if (p1 && !onlineUsers[p1.uid] && p1.status === "online") {
          await updateDoc(gameRef, { "players.player1.status": "offline" });
        }
        if (p2 && !onlineUsers[p2.uid] && p2.status === "online") {
          await updateDoc(gameRef, { "players.player2.status": "offline" });
        }
      }

      function bkg_updateUI(gameState) {
        const { players } = gameState,
          p1 = players.player1,
          p2 = players.player2;
        p1?.uid === bkg_currentUserId
          ? (bkg_playerNumber = "player1")
          : p2?.uid === bkg_currentUserId && (bkg_playerNumber = "player2");
        if (!bkg_playerNumber || !players[bkg_playerNumber]) return;

        const opponentPlayerNumber =
          bkg_playerNumber === "player1" ? "player2" : "player1";
        const opponent = players[opponentPlayerNumber];
        if (opponent && "offline" === opponent.status) {
          bkg_statusMessage.textContent = "Lawan telah keluar dari permainan.";
          bkg_choices.classList.add("hidden");
          bkg_playAgainBtn.classList.add("hidden-view");
          bkg_resultMessage.textContent = "";
          clearTimeout(afkTimeout);
          clearInterval(countdownInterval);
          return;
        }

        (bkg_player1NameEl.textContent = p1?.name || "Pemain 1"),
          (bkg_player2NameEl.textContent = p2?.name || "Menunggu...");
        const choiceMap = { rock: "‚úä", paper: "‚úã", scissors: "‚úå" };
        const displayChoice = (player, element, isOpponent) => {
          if (player?.choice) {
            if (!isOpponent || (p1?.choice && p2?.choice)) {
              element.textContent = choiceMap[player.choice];
            } else {
              element.textContent = "‚úÖ";
            }
          } else {
            element.textContent = "?";
          }
        };
        displayChoice(
          p1,
          bkg_player1ChoiceText,
          "player1" !== bkg_playerNumber
        ),
          displayChoice(
            p2,
            bkg_player2ChoiceText,
            "player2" !== bkg_playerNumber
          ),
          clearTimeout(afkTimeout),
          clearInterval(countdownInterval),
          p2
            ? p1.choice && p2.choice
              ? (bkg_choices.classList.add("hidden"),
                bkg_playAgainBtn.classList.remove("hidden-view"),
                "draw" === (e = determineWinner(p1.choice, p2.choice))
                  ? (bkg_resultMessage.textContent = "Hasilnya Seri!")
                  : e === bkg_playerNumber
                  ? (bkg_resultMessage.textContent = "Kamu Menang! üéâ")
                  : (bkg_resultMessage.textContent = "Kamu Kalah! üòû"),
                (t = players[bkg_playerNumber]),
                (a = players[opponentPlayerNumber]),
                t.wantsToPlayAgain
                  ? ((bkg_playAgainBtn.textContent = "Menunggu Lawan..."),
                    (bkg_playAgainBtn.disabled = !0),
                    (bkg_statusMessage.textContent =
                      "Menunggu persetujuan lawan..."))
                  : ((bkg_playAgainBtn.textContent = "Main Lagi"),
                    (bkg_playAgainBtn.disabled = !1),
                    a && a.wantsToPlayAgain
                      ? (bkg_statusMessage.textContent =
                          "Lawan menantangmu! Klik 'Main Lagi'.")
                      : (bkg_statusMessage.textContent =
                          "Klik 'Main Lagi' untuk rematch!")),
                p1.wantsToPlayAgain &&
                  p2.wantsToPlayAgain &&
                  "player1" === bkg_playerNumber &&
                  resetForNewRound())
              : (bkg_choices.classList.remove("hidden"),
                bkg_playAgainBtn.classList.add("hidden-view"),
                (bkg_resultMessage.textContent = ""),
                (e = 30),
                (bkg_statusMessage.textContent = `Pilih jagoanmu! Waktu: ${e}s`),
                (countdownInterval = setInterval(() => {
                  e--,
                    (bkg_statusMessage.textContent = `Pilih jagoanmu! Waktu: ${e}s`),
                    e <= 0 && clearInterval(countdownInterval);
                }, 1e3)),
                (afkTimeout = setTimeout(() => handleAfkTimeout(p1, p2), 3e4)))
            : ((bkg_statusMessage.textContent =
                "Bagikan kode untuk mengundang temanmu!"),
              bkg_choices.classList.add("hidden"),
              bkg_playAgainBtn.classList.add("hidden-view"),
              (bkg_resultMessage.textContent = ""));
        var e, t, a;
      }

      async function handleAfkTimeout(p1, p2) {
        const gameRef = doc(bkg_gamesCollection, bkg_currentRoomId),
          updates = {};
        let winnerMessage = "Waktu habis! ";
        p1.choice || p2.choice
          ? p1.choice
            ? p2.choice ||
              ((updates["players.player2.choice"] = "none"),
              (winnerMessage += `${p2.name} tidak memilih, ${p1.name} menang!`))
            : ((updates["players.player1.choice"] = "none"),
              (winnerMessage += `${p1.name} tidak memilih, ${p2.name} menang!`))
          : ((updates["players.player1.choice"] = "rock"),
            (updates["players.player2.choice"] = "rock"),
            (winnerMessage += "Tidak ada yang memilih, hasilnya Seri!")),
          bkg_showToast(winnerMessage, "info"),
          await updateDoc(gameRef, updates);
      }
      const determineWinner = (c1, c2) =>
        c1 === "none"
          ? "player2"
          : c2 === "none"
          ? "player1"
          : c1 === c2
          ? "draw"
          : ("rock" === c1 && "scissors" === c2) ||
            ("paper" === c1 && "rock" === c2) ||
            ("scissors" === c1 && "paper" === c2)
          ? "player1"
          : "player2";
      document
        .getElementById("rock")
        .addEventListener("click", () => bkg_handlePlayerChoice("rock"));
      document
        .getElementById("paper")
        .addEventListener("click", () => bkg_handlePlayerChoice("paper"));
      document
        .getElementById("scissors")
        .addEventListener("click", () => bkg_handlePlayerChoice("scissors"));
      const bkg_handlePlayerChoice = async (choice) => {
        if (!bkg_playerNumber || !bkg_currentRoomId) return;
        const gameRef = doc(bkg_gamesCollection, bkg_currentRoomId),
          fieldToUpdate = `players.${bkg_playerNumber}.choice`;
        await updateDoc(gameRef, { [fieldToUpdate]: choice });
      };
      bkg_playAgainBtn.addEventListener("click", async () => {
        if (!bkg_currentRoomId || !bkg_playerNumber) return;
        const gameRef = doc(bkg_gamesCollection, bkg_currentRoomId),
          fieldToUpdate = `players.${bkg_playerNumber}.wantsToPlayAgain`;
        await updateDoc(gameRef, { [fieldToUpdate]: !0 });
      });

      async function resetForNewRound() {
        if (!bkg_currentRoomId) return;
        const gameRef = doc(bkg_gamesCollection, bkg_currentRoomId);
        await updateDoc(gameRef, {
          "players.player1.choice": null,
          "players.player2.choice": null,
          "players.player1.wantsToPlayAgain": !1,
          "players.player1.status": "online",
          "players.player2.wantsToPlayAgain": !1,
          "players.player2.status": "online",
        });
      }

      // --- PERUBAHAN: Fungsi untuk memeriksa sesi saat halaman dimuat ---
      async function checkForSavedSession() {
        const savedRoomId = sessionStorage.getItem("bkg_roomId");
        const savedUserId = sessionStorage.getItem("bkg_userId");

        if (savedRoomId && savedUserId && savedUserId === bkg_currentUserId) {
          const gameRef = doc(bkg_gamesCollection, savedRoomId);
          const docSnap = await getDoc(gameRef);

          if (docSnap.exists()) {
            // Room masih ada, coba masuk kembali
            const players = docSnap.data().players;
            const myPlayerData =
              players.player1?.uid === savedUserId
                ? players.player1
                : players.player2;
            if (myPlayerData) {
              bkg_currentPlayerName = myPlayerData.name;
              bkg_joinRoom(savedRoomId);
              bkg_showToast("Berhasil terhubung kembali ke room!", "success");
            }
          } else {
            // Room sudah tidak ada, hapus sesi
            clearSession();
          }
        }
      }

      onAuthStateChanged(bkg_auth, (user) => {
        if (user) {
          bkg_currentUserId = user.uid;
          // PERUBAHAN: Coba masuk kembali ke sesi setelah user terautentikasi
          checkForSavedSession();
        }
      });

      signInAnonymously(bkg_auth).catch((err) =>
        console.error("BKG Auth Error:", err)
      );
    </script>
  </body>
</html>
